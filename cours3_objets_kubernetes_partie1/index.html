<!doctype html><html lang=fr-fr dir=ltr><head><meta charset=utf-8><meta name=viewport content="height=device-height,width=device-width,initial-scale=1,minimum-scale=1"><meta name=generator content="Hugo 0.121.1"><meta name=generator content="Relearn 5.23.2+tip"><meta name=description content="TP - Intro √† k8s"><meta name=author content="Alexandre P."><meta name=twitter:card content="summary"><meta name=twitter:title content="Les objets Kubernetes - Partie 1 - Introduction √† Kubernetes"><meta name=twitter:description content="TP - Intro √† k8s"><meta property="og:title" content="Les objets Kubernetes - Partie 1 - Introduction √† Kubernetes"><meta property="og:description" content="TP - Intro √† k8s"><meta property="og:type" content="website"><meta property="og:url" content="https://zaggash.github.io/tp-iut-kubernetes/cours3_objets_kubernetes_partie1/"><meta property="og:site_name" content="Introduction √† Kubernetes"><title>Les objets Kubernetes - Partie 1 - Introduction √† Kubernetes</title>
<link href=../cours3_objets_kubernetes_partie1/index.xml rel=alternate type=application/rss+xml title="Les objets Kubernetes - Partie 1 - Introduction √† Kubernetes"><link href=../css/fontawesome-all.min.css rel=stylesheet media=print onload='this.media="all",this.onload=null'><noscript><link href=../css/fontawesome-all.min.css rel=stylesheet></noscript><link href=../css/nucleus.css rel=stylesheet><link href=../css/auto-complete.css rel=stylesheet media=print onload='this.media="all",this.onload=null'><noscript><link href=../css/auto-complete.css rel=stylesheet></noscript><link href=../css/perfect-scrollbar.min.css rel=stylesheet><link href=../css/fonts.css rel=stylesheet media=print onload='this.media="all",this.onload=null'><noscript><link href=../css/fonts.css rel=stylesheet></noscript><link href=../css/theme.css rel=stylesheet><link href=../css/theme-blue.css rel=stylesheet id=R-variant-style><link href=../css/chroma-learn.css rel=stylesheet id=R-variant-chroma-style><link href=../css/variant.css rel=stylesheet><link href=../css/print.css rel=stylesheet media=print><link href=../css/ie.css rel=stylesheet><script src=../js/url.js></script><script src=../js/variant.js></script><script>window.index_js_url="../index.search.js";var root_url="../",baseUri=root_url.replace(/\/$/,"");window.relearn=window.relearn||{},window.relearn.baseUriFull="https://zaggash.github.io/tp-iut-kubernetes/",window.relearn.themeVariantModifier="",window.variants&&variants.init(["blue"]),window.T_Copy_to_clipboard=`Copier dans le presse-papiers`,window.T_Copied_to_clipboard=`Copi√© dans le presse-papiers!`,window.T_Copy_link_to_clipboard=`Copier le lien dans le presse-papiers`,window.T_Link_copied_to_clipboard=`Lien copi√© dans le presse-papiers!`,window.T_Reset_view=`R√©initialiser la vue`,window.T_View_reset=`Vue r√©initialis√©e!`,window.T_No_results_found=`Aucun r√©sultat trouv√© pour "{0}"`,window.T_N_results_found=`{1} r√©sultats trouv√©s pour "{0}"`</script></head><body class="mobile-support html" data-url=../cours3_objets_kubernetes_partie1/><div id=R-body class=default-animation><div id=R-body-overlay></div><nav id=R-topbar><div class=topbar-wrapper><div class=topbar-sidebar-divider></div><div class="topbar-area topbar-area-start" data-area=start><div class="topbar-button topbar-button-sidebar" data-content-empty=disable data-width-s=show data-width-m=hide data-width-l=hide><button class=topbar-control onclick=toggleNav() type=button title="Menu (CTRL+ALT+n)"><i class="fa-fw fas fa-bars"></i></button></div><div class="topbar-button topbar-button-toc" data-content-empty=hide data-width-s=show data-width-m=show data-width-l=show><button class=topbar-control onclick=toggleTopbarFlyout(this) type=button title="Table des mati√®res (CTRL+ALT+t)"><i class="fa-fw fas fa-list-alt"></i></button><div class=topbar-content><div class=topbar-content-wrapper><nav class=TableOfContents><ul><li><a href=#lapi-et-les-objets-kubernetes>L&rsquo;API et les Objets Kubernetes</a><ul><li><a href=#la-commande-apply>La commande <code>apply</code></a></li></ul></li><li><a href=#parenth√®se--le-yaml>Parenth√®se : Le YAML</a></li><li><a href=#syntaxe>Syntaxe</a><ul><li><a href=#syntaxe-de-base-dune-description-yaml-kubernetes>Syntaxe de base d&rsquo;une description YAML Kubernetes</a></li><li><a href=#description-de-plusieurs-ressources>Description de plusieurs ressources</a></li></ul></li></ul><ul><li><ul><li><a href=#les-namespaces>Les namespaces</a></li><li><a href=#les-pods>Les Pods</a></li></ul></li><li><a href=#rappel-sur-quelques-concepts>Rappel sur quelques concepts</a><ul><li><a href=#haute-disponibilit√©>Haute disponibilit√©</a></li><li><a href=#r√©partition-de-charge-load-balancing>R√©partition de charge (load balancing)</a></li><li><a href=#healthchecks>Healthchecks</a></li><li><a href=#application-microservices>Application microservices</a></li></ul></li><li><a href=#larchitecture-d√©coupl√©e-des-services-kubernetes>L&rsquo;architecture d√©coupl√©e des services Kubernetes</a><ul><li><a href=#les-deployments-deploy>Les Deployments (deploy)</a></li><li><a href=#les-replicasets-rs>Les ReplicaSets (rs)</a></li><li><a href=#les-services>Les Services</a></li></ul></li><li><a href=#les-autres-types-de-workloads-kubernetes>Les autres types de Workloads Kubernetes</a><ul><li><a href=#jobs>Jobs</a></li><li><a href=#cronjobs>CronJobs</a></li></ul></li></ul></nav></div></div></div></div><span class="topbar-breadcrumbs highlightable">Les objets Kubernetes - Partie 1</span><div class="topbar-area topbar-area-end" data-area=end><div class="topbar-button topbar-button-prev" data-content-empty=disable data-width-s=show data-width-m=show data-width-l=show><a class=topbar-control href=../td1-installation/ title="TD - Installation et Configuration (ü°ê)"><i class="fa-fw fas fa-chevron-left"></i></a></div><div class="topbar-button topbar-button-next" data-content-empty=disable data-width-s=show data-width-m=show data-width-l=show><a class=topbar-control href=../td2-deployer-wordpress/ title="TD - Deployer Wordpress (ü°í)"><i class="fa-fw fas fa-chevron-right"></i></a></div><div class="topbar-button topbar-button-more" data-content-empty=hide data-width-s=show data-width-m=show data-width-l=show><button class=topbar-control onclick=toggleTopbarFlyout(this) type=button title="Aller plus loin"><i class="fa-fw fas fa-ellipsis-v"></i></button><div class=topbar-content><div class=topbar-content-wrapper><div class="topbar-area topbar-area-more" data-area=more></div></div></div></div></div></div></nav><div id=R-main-overlay></div><main id=R-body-inner class="highlightable default" tabindex=-1><div class=flex-block-wrapper><article class=default><header class=headline></header><h1 id=les-objets-kubernetes---partie-1>Les objets Kubernetes - Partie 1</h1><h2 id=lapi-et-les-objets-kubernetes>L&rsquo;API et les Objets Kubernetes</h2><p>Utiliser Kubernetes consiste √† d√©clarer des objets gr√¢ce √† l‚ÄôAPI Kubernetes pour d√©crire l‚Äô√©tat souhait√© d&rsquo;un cluster : quelles applications ou autres processus ex√©cuter, quelles images elles utilisent, le nombre de replicas, les ressources r√©seau et disque que vous mettez √† disposition, etc.</p><p>On d√©finit des objets g√©n√©ralement via l‚Äôinterface en ligne de commande et <code>kubectl</code> de deux fa√ßons :</p><ul><li>en lan√ßant une commande <code>kubectl run &lt;conteneur> ...</code>, <code>kubectl expose ...</code></li><li>en d√©crivant un objet dans un fichier YAML ou JSON et en le passant au client <code>kubectl apply -f monpod.yml</code></li></ul><p>Vous pouvez √©galement √©crire des programmes qui utilisent directement l‚ÄôAPI Kubernetes pour interagir avec le cluster et d√©finir ou modifier l‚Äô√©tat souhait√©. <strong>Kubernetes est compl√®tement automatisable !</strong></p><h3 id=la-commande-apply>La commande <code>apply</code></h3><p>Kubernetes encourage le principe de l&rsquo;infrastructure-as-code : il est recommand√© d&rsquo;utiliser une description YAML et versionn√©e des objets et configurations Kubernetes plut√¥t que la CLI.</p><p>Pour cela la commande de base est <code>kubectl apply -f object.yaml</code>.</p><p>La commande inverse <code>kubectl delete -f object.yaml</code> permet de d√©truire un objet pr√©c√©dement appliqu√© dans le cluster √† partir de sa description.</p><p>Lorsqu&rsquo;on vient d&rsquo;appliquer une description on peut l&rsquo;afficher dans le terminal avec <code>kubectl apply -f myobj.yaml view-last-applied</code></p><p>Globalement Kubernetes garde un historique de toutes les transformations des objets : on peut explorer, par exemple avec la commande <code>kubectl rollout history deployment</code>.</p><h2 id=parenth√®se--le-yaml>Parenth√®se : Le YAML</h2><p>Kubernetes d√©crit ses ressources en YAML. A quoi √ßa ressemble, YAML ?</p><div class="wrap-code highlight"><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#f92672>march√©</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>lieu</span>: <span style=color:#ae81ff>March√© de la Place</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>jour</span>: <span style=color:#ae81ff>jeudi</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>horaire</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>unit√©</span>: <span style=color:#e6db74>&#34;heure&#34;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>min</span>: <span style=color:#ae81ff>12</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>max</span>: <span style=color:#ae81ff>20</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>fruits</span>:
</span></span><span style=display:flex><span>      - <span style=color:#f92672>nom</span>: <span style=color:#ae81ff>pomme</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>couleur</span>: <span style=color:#e6db74>&#34;verte&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>pesticide</span>: <span style=color:#ae81ff>avec</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      - <span style=color:#f92672>nom</span>: <span style=color:#ae81ff>poires</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>couleur</span>: <span style=color:#ae81ff>jaune</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>pesticide</span>: <span style=color:#ae81ff>sans</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>l√©gumes</span>:
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>courgettes</span>
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>salade</span>
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>potiron</span></span></span></code></pre></div><h2 id=syntaxe>Syntaxe</h2><ul><li><p>Alignement ! (<strong>2 espaces</strong> !!)</p></li><li><p>ALIGNEMENT !! (comme en python)</p></li><li><p><strong>ALIGNEMENT !!!</strong> (le d√©faut du YAML, pas de correcteur syntaxique automatique, c&rsquo;est b√™te mais vous y perdrez forc√©ment du temps !)</p></li><li><p>des listes (tirets)</p></li><li><p>des paires <strong>cl√©: valeur</strong></p></li><li><p>Un peu comme du JSON, avec cette grosse diff√©rence que le JSON se fiche de l&rsquo;alignement et met des accolades et des points-virgules</p></li><li><p><strong>les extensions Kubernetes et YAML dans VSCode vous aident √† rep√©rer des erreurs</strong></p></li></ul><h3 id=syntaxe-de-base-dune-description-yaml-kubernetes>Syntaxe de base d&rsquo;une description YAML Kubernetes</h3><p>Les descriptions YAML permettent de d√©crire de fa√ßon lisible et manipulable de nombreuses caract√©ristiques des ressources Kubernetes (un peu comme un <em>Compose file</em> par rapport √† la CLI Docker).</p><h4 id=exemple>Exemple</h4><p>Cr√©ation d&rsquo;un service simple :</p><div class="wrap-code highlight"><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>Service</span>
</span></span><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>v1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>labels</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>k8s-app</span>: <span style=color:#ae81ff>kubernetes-dashboard</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>kubernetes-dashboard</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>namespace</span>: <span style=color:#ae81ff>kubernetes-dashboard</span>
</span></span><span style=display:flex><span><span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>ports</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>port</span>: <span style=color:#ae81ff>443</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>targetPort</span>: <span style=color:#ae81ff>8443</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>selector</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>k8s-app</span>: <span style=color:#ae81ff>kubernetes-dashboard</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>type</span>: <span style=color:#ae81ff>NodePort</span></span></span></code></pre></div><p>Remarques de syntaxe :</p><ul><li>Toutes les descriptions doivent commencer par sp√©cifier la version d&rsquo;API (minimale) selon laquelle les objets sont cens√©s √™tre cr√©√©s</li><li>Il faut √©galement pr√©ciser le type d&rsquo;objet avec <code>kind</code></li><li>Le nom dans <code>metadata:\n name: value</code> est √©galement obligatoire.</li><li>On rajoute g√©n√©ralement une description longue d√©marrant par <code>spec:</code></li></ul><h3 id=description-de-plusieurs-ressources>Description de plusieurs ressources</h3><ul><li><p>On peut mettre plusieurs ressources √† la suite dans un fichier k8s : cela permet de d√©crire une installation complexe en un seul fichier</p><ul><li>par exemple le dashboard Kubernetes <a href=https://github.com/kubernetes/dashboard/ target=_blank>https://github.com/kubernetes/dashboard/</a></li></ul></li><li><p>L&rsquo;ordre n&rsquo;importe pas car les ressources sont d√©crites d√©clarativement c&rsquo;est-√†-dire que:</p><ul><li>Les d√©pendances entre les ressources sont d√©clar√©es</li><li>Le control plane de Kubernetes se charge de planifier l&rsquo;ordre correct de cr√©ation en fonction des d√©pendances (pods avant le d√©ploiement, r√¥le avec l&rsquo;utilisateur li√© au r√¥le)</li><li>On pr√©f√®re cependant les mettre dans un ordre logique pour que les humains puissent les lire.</li></ul></li><li><p>On peut sauter des lignes dans le YAML et rendre plus lisible les descriptions</p></li><li><p>On s√©pare les diff√©rents objets par <code>---</code></p></li></ul><h1 id=objets-de-base>Objets de base</h1><h3 id=les-namespaces>Les namespaces</h3><p>Tous les objets Kubernetes sont rang√©s dans diff√©rents espaces de travail isol√©s appel√©s <code>namespaces</code>.</p><p>Cette isolation permet 3 choses :</p><ul><li>ne voir que ce qui concerne une t√¢che particuli√®re (ne r√©fl√©chir que sur une seule chose lorsqu&rsquo;on op√®re sur un cluster)</li><li>cr√©er des limites de ressources (CPU, RAM, etc.) pour le namespace</li><li>d√©finir des r√¥les et permissions sur le namespace qui s&rsquo;appliquent √† toutes les ressources √† l&rsquo;int√©rieur.</li></ul><p>Lorsqu&rsquo;on lit ou cr√©√© des objets sans pr√©ciser le namespace, ces objets sont li√©s au namespace <code>default</code>.</p><p>Pour utiliser un namespace autre que <code>default</code> avec <code>kubectl</code> il faut :</p><ul><li>le pr√©ciser avec l&rsquo;option <code>-n</code> : <code>kubectl get pods -n kube-system</code></li><li>cr√©er une nouvelle configuration dans la kubeconfig pour changer le namespace par defaut.</li></ul><p>Kubernetes g√®re lui-m√™me ses composants internes sous forme de pods et services.</p><ul><li>Si vous ne trouvez pas un objet, essayez de lancer la commande kubectl avec l&rsquo;option <code>-A</code> ou <code>--all-namespaces</code></li></ul><h3 id=les-pods>Les Pods</h3><p>Un Pod est l‚Äôunit√© d‚Äôex√©cution de base d‚Äôune application Kubernetes que vous cr√©ez ou d√©ployez. Un Pod repr√©sente des process en cours d‚Äôex√©cution dans votre Cluster.</p><p>Un Pod encapsule un conteneur (ou souvent plusieurs conteneurs), des ressources de stockage, <strong>une IP r√©seau unique</strong>, et des options qui contr√¥lent comment le ou les conteneurs doivent s‚Äôex√©cuter (ex: <em>restart policy</em>). Cette collection de conteneurs et volumes tournent dans le m√™me environnement d&rsquo;ex√©cution mais les processus sont isol√©s.</p><p>Un Pod repr√©sente une unit√© de d√©ploiement : un petit nombre de conteneurs qui sont √©troitement li√©s et qui partagent :</p><ul><li>les m√™mes ressources de calcul</li><li>des volumes communs</li><li>la m√™me IP donc le m√™me nom de domaine</li><li>peuvent se parler sur localhost</li><li>peuvent se parler en IPC</li><li>ont un nom diff√©rent et des logs diff√©rents</li></ul><p>Chaque Pod est destin√© √† ex√©cuter une instance unique d‚Äôun workload donn√©. Si vous d√©sirez mettre √† l‚Äô√©chelle votre workload, vous devez multiplier le nombre de Pods avec un d√©ploiement.</p><p>Pour plus de d√©tail sur la philosophie des pods, vous pouvez consulter <a href=https://www.mirantis.com/blog/multi-container-pods-and-container-communication-in-kubernetes/ target=_blank>ce bon article</a>.</p><p>Kubernetes fournit un ensemble de commande pour d√©bugger des conteneurs :</p><ul><li><code>kubectl logs &lt;pod-name> -c &lt;conteneur_name></code> (le nom du conteneur est inutile si un seul)</li><li><code>kubectl exec -it &lt;pod-name> -c &lt;conteneur_name> -- bash</code></li><li><code>kubectl attach -it &lt;pod-name></code></li></ul><p>Enfin, pour debugger la sortie r√©seau d&rsquo;un programme on peut rapidement forwarder un port depuis un pods vers l&rsquo;ext√©rieur du cluster :</p><ul><li><code>kubectl port-forward &lt;pod-name> &lt;port_interne>:&lt;port_externe></code></li><li>C&rsquo;est une commande de debug seulement : pour exposer correctement des processus k8s, il faut cr√©er un service, par exemple avec <code>NodePort</code>.</li></ul><p>Pour copier un fichier dans un pod on peut utiliser: <code>kubectl cp &lt;pod-name>:&lt;/path/to/remote/file> &lt;/path/to/local/file></code></p><p>Pour monitorer rapidement les ressources consomm√©es par un ensemble de processus il existe les commande <code>kubectl top nodes</code> et <code>kubectl top pods</code></p><h5 id=un-manifest-de-pod>Un manifest de Pod</h5><p><code>rancher-demo-pod.yaml</code></p><div class="wrap-code highlight"><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>v1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>Pod</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>rancher-demo-pod</span>
</span></span><span style=display:flex><span><span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>containers</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>image</span>: <span style=color:#ae81ff>monachus/rancher-demo:latest</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>name</span>: <span style=color:#ae81ff>rancher-demo-container</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>ports</span>:
</span></span><span style=display:flex><span>        - <span style=color:#f92672>containerPort</span>: <span style=color:#ae81ff>8080</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>name</span>: <span style=color:#ae81ff>http</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>protocol</span>: <span style=color:#ae81ff>TCP</span>
</span></span><span style=display:flex><span>    - <span style=color:#f92672>image</span>: <span style=color:#ae81ff>redis</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>name</span>: <span style=color:#ae81ff>redis-container</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>ports</span>:
</span></span><span style=display:flex><span>        - <span style=color:#f92672>containerPort</span>: <span style=color:#ae81ff>6379</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>name</span>: <span style=color:#ae81ff>http</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>protocol</span>: <span style=color:#ae81ff>TCP</span></span></span></code></pre></div><h2 id=rappel-sur-quelques-concepts>Rappel sur quelques concepts</h2><h3 id=haute-disponibilit√©>Haute disponibilit√©</h3><ul><li>Faire en sorte qu&rsquo;un service ait un &ldquo;uptime&rdquo; √©lev√©.</li></ul><p>On veut que le service soit tout le temps accessible m√™me lorsque certaines ressources manquent :</p><ul><li>elles tombent en panne</li><li>elles sont sorties du service pour mise √† jour, maintenance ou modification</li></ul><p>Pour cela on doit avoir des ressources multiples&mldr;</p><ul><li>Plusieurs serveurs</li><li>Plusieurs versions des donn√©es</li><li>Plusieurs acc√®s r√©seau</li></ul><p>Il faut que les ressources disponibles prennent automatiquement le relais des ressources indisponibles.
Pour cela on utilise en particulier:</p><ul><li>des &ldquo;load balancers&rdquo; : aiguillages r√©seau intelligents</li><li>des &ldquo;healthchecks&rdquo; : une v√©rification de la sant√© des applications</li></ul><p>Nous allons voir que Kubernetes int√®gre automatiquement les principes de load balancing et de healthcheck dans l&rsquo;orchestration de conteneurs</p><h3 id=r√©partition-de-charge-load-balancing>R√©partition de charge (load balancing)</h3><ul><li>Un load balancer : une sorte d&rsquo;<strong>&ldquo;aiguillage&rdquo; de trafic r√©seau</strong>, typiquement HTTP(S) ou TCP.</li><li>Un aiguillage <strong>intelligent</strong> qui se renseigne sur plusieurs crit√®res avant de choisir la direction.</li></ul><p>Cas d&rsquo;usage :</p><ul><li>√âviter la surcharge : les requ√™tes sont r√©parties sur diff√©rents backends pour √©viter de les saturer.</li></ul><p>L&rsquo;objectif est de permettre la haute disponibilit√© : on veut que notre service soit toujours disponible, m√™me en p√©riode de panne/maintenance.</p><ul><li><p>Donc on va dupliquer chaque partie de notre service et mettre les diff√©rentes instances derri√®re un load balancer.</p></li><li><p>Le load balancer va v√©rifier pour chaque backend s&rsquo;il est disponible (<strong>healthcheck</strong>) avant de rediriger le trafic.</p></li><li><p>R√©partition g√©ographique : en fonction de la provenance des requ√™tes on va rediriger vers un datacenter adapt√© (+ proche).</p></li></ul><h3 id=healthchecks>Healthchecks</h3><p>Fournir √† l&rsquo;application une fa√ßon d&rsquo;indiquer qu&rsquo;elle est disponible, c&rsquo;est-√†-dire :</p><ul><li>qu&rsquo;elle est d√©marr√©e (<em>liveness</em>)</li><li>qu&rsquo;elle peut r√©pondre aux requ√™tes (<em>readiness</em>).</li></ul><h3 id=application-microservices>Application microservices</h3><ul><li><p>Une application compos√©e de nombreux petits services communiquant via le r√©seau. Le calcul pour r√©pondre √† une requ√™te est d√©compos√© en diff√©rente parties distribu√©es entre les services. Par exemple:</p></li><li><p>un service est responsable de la gestion des <strong>clients</strong> et un autre de la gestion des <strong>commandes</strong>.</p></li><li><p>Ce mode de d√©veloppement implique souvent des architectures complexes pour √™tre mis en oeuvre et kubernetes est pens√© pour faciliter leur gestion √† grande √©chelle.</p></li><li><p>Imaginez devoir relancer manuellement des services vitaux pour une application en h√©bergeant des centaines d&rsquo;instances : c&rsquo;est en particulier √† ce moment que kubernetes devient indispensable.</p></li></ul><h5 id=2-exemples-dapplication-microservices>2 exemples d&rsquo;application microservices:</h5><ul><li><a href=https://github.com/microservices-patterns/ftgo-application target=_blank>https://github.com/microservices-patterns/ftgo-application</a> -> fonctionne avec le tr√®s bon livre <code>Microservices pattern</code> visible sur le readme.</li><li><a href=https://github.com/GoogleCloudPlatform/microservices-demo target=_blank>https://github.com/GoogleCloudPlatform/microservices-demo</a> -> Exemple d&rsquo;application microservice de r√©f√©rence de Google pour Kubernetes.</li></ul><h2 id=larchitecture-d√©coupl√©e-des-services-kubernetes>L&rsquo;architecture d√©coupl√©e des services Kubernetes</h2><p><a href=#R-image-f9c2e40849a3b65dd0db450a6f565c6d class=lightbox-link><img src=../cours3_objets_kubernetes_partie1/deploy-decoupled-pattern.png alt class="figure-image noborder lightbox noshadow" style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-f9c2e40849a3b65dd0db450a6f565c6d><img src=../cours3_objets_kubernetes_partie1/deploy-decoupled-pattern.png alt class="lightbox-image noborder lightbox noshadow" loading=lazy></a></p><p>Comme nous l&rsquo;avons vu dans le TD precedent, d√©ployer une application dans kubernetes demande plusieurs √©tapes. En r√©alit√© en plus des <strong>pods</strong> l&rsquo;ensemble de la gestion d&rsquo;un service applicatif se d√©compose dans Kubernetes en 3 √† 4 objets articul√©s entre eux:</p><ul><li><strong>replicatset</strong></li><li><strong>deployment</strong></li><li><strong>service</strong></li><li><strong>(ingress)</strong></li></ul><h3 id=les-deployments-deploy>Les Deployments (deploy)</h3><p>Les d√©ploiements sont les objets effectivement cr√©√©s manuellement lorsqu&rsquo;on d√©ploie une application. Ce sont des objets de plus haut niveau que les <strong>pods</strong> et <strong>replicaset</strong> et les pilote pour g√©rer un d√©ploiement applicatif.</p><p><a href=#R-image-235635d1c87b013f5fbb3254ceddc289 class=lightbox-link><img src=../cours3_objets_kubernetes_partie1/wiki-ciscolinux-co-uk-russiandolls.png alt class="figure-image noborder lightbox noshadow" style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-235635d1c87b013f5fbb3254ceddc289><img src=../cours3_objets_kubernetes_partie1/wiki-ciscolinux-co-uk-russiandolls.png alt class="lightbox-image noborder lightbox noshadow" loading=lazy></a>
<em>Les poup√©es russes Kubernetes : un Deployment contient un ReplicaSet, qui contient des Pods, qui contiennent des conteneurs</em></p><p>S&rsquo;il c&rsquo;est n√©cessaire d&rsquo;avoir ces trois types de ressources c&rsquo;est parce que Kubernetes respecte un principe de d√©couplage des responsabilit√©s.</p><p>La responsabilit√© d&rsquo;un d√©ploiement est de g√©rer la coexistence et le <strong>tracking de versions</strong> multiples d&rsquo;une application et d&rsquo;effectuer des mont√©es de version automatiques en haute disponibilit√© en suivant une <strong>RolloutStrategy</strong>.</p><p>Ainsi lors des changements de version, un seul <strong>deployment</strong> g√®re automatiquement de multiples <strong>replicasets</strong> contenant chacun <strong>une version</strong> de l&rsquo;application => Le d√©couplage est n√©cessaire.</p><p>Un <em>deployment</em> implique la cr√©ation d&rsquo;un ensemble de Pods d√©sign√©s par une √©tiquette <code>label</code> et regroup√© dans un <strong>Replicaset</strong>.</p><p>Exemple :</p><div class="wrap-code highlight"><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>apps/v1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>Deployment</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>nginx-deployment</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>labels</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>app</span>: <span style=color:#ae81ff>nginx</span>
</span></span><span style=display:flex><span><span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>replicas</span>: <span style=color:#ae81ff>3</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>strategy</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>type</span>: <span style=color:#ae81ff>Recreate</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>selector</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>matchLabels</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>app</span>: <span style=color:#ae81ff>nginx</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>template</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>labels</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>app</span>: <span style=color:#ae81ff>nginx</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>containers</span>:
</span></span><span style=display:flex><span>        - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>nginx</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>image</span>: <span style=color:#ae81ff>nginx:1.7.9</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>ports</span>:
</span></span><span style=display:flex><span>            - <span style=color:#f92672>containerPort</span>: <span style=color:#ae81ff>80</span></span></span></code></pre></div><ul><li><p>Pour les afficher : <code>kubectl get deployments</code></p></li><li><p>La commande <code>kubectl run</code> sert √† cr√©er un <em>deployment</em> √† partir d&rsquo;un mod√®le. Il vaut mieux utilisez <code>apply -f</code>.</p></li></ul><h3 id=les-replicasets-rs>Les ReplicaSets (rs)</h3><p>Dans notre mod√®le, les <strong>ReplicaSet</strong> servent √† g√©rer et sont responsables pour:</p><ul><li><p>la r√©plication (avoir le bon nombre d&rsquo;instances et le scaling)</p></li><li><p>la sant√© et le red√©marrage automatique des pods de l&rsquo;application (Self-Healing)</p></li><li><p><code>kubectl get rs</code> pour afficher la liste des replicas.</p></li></ul><p>En g√©n√©ral on ne les manipule pas directement (c&rsquo;est d√©conseill√©) m√™me s&rsquo;il est possible de les modifier et de les cr√©er avec un fichier de ressource. Pour cr√©er des groupes de conteneurs on utilise soit un <strong>Deployment</strong> soit d&rsquo;autres formes de workloads (<strong>DaemonSet</strong>, <strong>StatefulSet</strong>, <strong>Job</strong>) adapt√©s √† d&rsquo;autres cas.</p><h3 id=les-services>Les Services</h3><p>Dans Kubernetes, un <strong>service</strong> est un objet qui :</p><ul><li>D√©signe un ensemble de pods (gr√¢ce √† des tags) g√©n√©ralement g√©r√© par un d√©ploiement.</li><li>Fournit un endpoint r√©seau pour les requ√™tes √† destination de ces pods.</li><li>Configure une politique permettant d‚Äôy acc√©der depuis l&rsquo;int√©rieur ou l&rsquo;ext√©rieur du cluster.</li></ul><p>L‚Äôensemble des pods cibl√©s par un service est d√©termin√© par un <code>selector</code>.</p><p>Par exemple, consid√©rons un backend de traitement d‚Äôimage (<em>stateless</em>, c&rsquo;est-√†-dire ici sans base de donn√©es) qui s‚Äôex√©cute avec 3 replicas. Ces replicas sont interchangeables et les frontends ne se soucient pas du backend qu‚Äôils utilisent. Bien que les pods r√©els qui composent l‚Äôensemble <code>backend</code> puissent changer, les clients frontends ne devraient pas avoir besoin de le savoir, pas plus qu‚Äôils ne doivent suivre eux-m√™mes l&rsquo;√©tat de l‚Äôensemble des backends.</p><p>L‚Äôabstraction du service permet ce d√©couplage : les clients frontend s&rsquo;addressent √† une seule IP avec un seul port d√®s qu&rsquo;ils ont besoin d&rsquo;avoir recours √† un backend. Les backends vont recevoir la requ√™te du frontend al√©atoirement.</p><p>Les Services sont de trois types principaux :</p><ul><li><p><code>ClusterIP</code>: expose le service <strong>sur une IP interne</strong> au cluster. Les autres pods peuvent alors acc√©der au service de l&rsquo;int√©rieur du cluster, mais il n&rsquo;est pas l&rsquo;ext√©rieur.</p></li><li><p><code>NodePort</code>: expose le service depuis l&rsquo;IP de <strong>chacun des noeuds du cluster</strong> en ouvrant un port directement sur le n≈ìud, entre 30000 et 32767. Cela permet d&rsquo;acc√©der aux pods internes r√©pliqu√©s. Comme l&rsquo;IP est stable on peut faire pointer un DNS ou Loadbalancer classique dessus.</p></li></ul><p><a href=#R-image-dbe65e4b456aa05c51b4f5f83b465ae1 class=lightbox-link><img src=../cours3_objets_kubernetes_partie1/nodeport.png alt class="figure-image noborder lightbox noshadow" style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-dbe65e4b456aa05c51b4f5f83b465ae1><img src=../cours3_objets_kubernetes_partie1/nodeport.png alt class="lightbox-image noborder lightbox noshadow" loading=lazy></a></p><ul><li><code>LoadBalancer</code>: expose le service en externe √† l‚Äôaide d&rsquo;un Loadbalancer de fournisseur de cloud. Les services NodePort et ClusterIP, vers lesquels le Loadbalancer est dirig√© sont automatiquement cr√©√©s.</li></ul><p><a href=#R-image-ec28a0b65f5ea0c4902279518693ca10 class=lightbox-link><img src=../cours3_objets_kubernetes_partie1/loadbalancer.png alt class="figure-image noborder lightbox noshadow" style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-ec28a0b65f5ea0c4902279518693ca10><img src=../cours3_objets_kubernetes_partie1/loadbalancer.png alt class="lightbox-image noborder lightbox noshadow" loading=lazy></a></p><h2 id=les-autres-types-de-workloads-kubernetes>Les autres types de Workloads Kubernetes</h2><p><a href=#R-image-661d6eb3341b2fd4ca35cbed60ca9395 class=lightbox-link><img src=./k8s_objects_hierarchy.png alt class="figure-image noborder lightbox noshadow" style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-661d6eb3341b2fd4ca35cbed60ca9395><img src=./k8s_objects_hierarchy.png alt class="lightbox-image noborder lightbox noshadow" loading=lazy></a></p><p>En plus du d√©ploiement d&rsquo;un application, Il existe pleins d&rsquo;autre raisons de cr√©er un ensemble de Pods:</p><ul><li>Le <strong>DaemonSet</strong>: Faire tourner un agent ou d√©mon sur chaque n≈ìud, par exemple pour des besoins de monitoring, ou pour configurer le r√©seau sur chacun des n≈ìuds.</li><li>Le <strong>Job</strong> : Effectuer une tache unique de dur√©e limit√©e et ponctuelle, par exemple de nettoyage d&rsquo;un volume ou la pr√©paration initiale d&rsquo;une application, etc.</li><li>Le <strong>CronJob</strong> : Effectuer une tache unique de dur√©e limit√©e et r√©currente, par exemple de backup ou de r√©g√©n√©ration de certificat, etc.</li></ul><p>De plus m√™me pour faire tourner une application, les d√©ploiements ne sont pas toujours suffisants. En effet ils sont peu adapt√©s √† des applications statefull comme les bases de donn√©es de toutes sortes qui ont besoin de persister des donn√©es critiques. Pour cel√† on utilise un <strong>StatefulSet</strong> que nous verrons par la suite.</p><p>√âtant donn√© les similitudes entre les DaemonSets, les StatefulSets et les Deployments, il est important de comprendre un peu pr√©cis√©ment quand les utiliser.</p><p>Les <strong>Deployments</strong> (li√©s √† des ReplicaSets) doivent √™tre utilis√©s :</p><ul><li>lorsque votre application est compl√®tement d√©coupl√©e du n≈ìud</li><li>que vous pouvez en ex√©cuter plusieurs copies sur un n≈ìud donn√© sans consid√©ration particuli√®re</li><li>que l&rsquo;ordre de cr√©ation des replicas et le nom des pods n&rsquo;est pas important</li><li>lorsqu&rsquo;on fait des op√©rations <em>stateless</em></li></ul><p>Les <strong>DaemonSets</strong> doivent √™tre utilis√©s :</p><ul><li>lorsqu&rsquo;au moins une copie de votre application doit √™tre ex√©cut√©e sur tous les n≈ìuds du cluster (ou sur un sous-ensemble de ces n≈ìuds).</li></ul><p>Les <strong>StatefulSets</strong> doivent √™tre utilis√©s :</p><ul><li>lorsque l&rsquo;ordre de cr√©ation des replicas et le nom des pods est important</li><li>lorsqu&rsquo;on fait des op√©rations <em>stateful</em> (√©crire dans une base de donn√©es)</li></ul><h3 id=jobs>Jobs</h3><p>Les jobs sont utiles pour les choses que vous ne voulez faire qu&rsquo;une seule fois, comme les migrations de bases de donn√©es ou les travaux par lots. Si vous ex√©cutez une migration en tant que Pod dans un deployment:</p><ul><li>D√®s que la migration se finit le processus du pod s&rsquo;arr√™te.</li><li>Le <strong>replicaset</strong> qui d√©tecte que l&rsquo;&ldquo;application&rdquo; s&rsquo;est arr√™ter va tenter de la red√©marrer en recr√©ant le pod.</li><li>Votre t√¢che de migration de base de donn√©es se d√©roulera donc en boucle, en repeuplant continuellement la base de donn√©es.</li></ul><h3 id=cronjobs>CronJobs</h3><p>Comme des jobs, mais se lancent √† un intervalle r√©gulier, comme les <code>cron</code> sur les syst√®mes unix.</p><footer class=footline></footer></article></div></main></div><aside id=R-sidebar class="default-animation showVisitedLinks"><div id=R-header-topbar class=default-animation></div><div id=R-header-wrapper class=default-animation><div id=R-header class=default-animation><a id=logo href=https://zaggash.github.io/tp-iut-kubernetes/><img src=https://upload.wikimedia.org/wikipedia/commons/thumb/3/39/Kubernetes_logo_without_workmark.svg/247px-Kubernetes_logo_without_workmark.svg.png alt="k8s logo"></a></div><div class="searchbox default-animation"><i class="fas fa-search" title="Rechercher (CTRL+ALT+f)"></i>
<label class=a11y-only for=R-search-by>Rechercher</label>
<input data-search-input id=R-search-by name=search-by class=search-by type=search placeholder=Rechercher...>
<button class=search-clear type=button data-search-clear title="Recherche claire"><i class="fas fa-times" title="Recherche claire"></i></button></div><script>var contentLangs=["fr"]</script><script src=../js/auto-complete.js defer></script><script src=../js/lunr/lunr.min.js defer></script><script src=../js/lunr/lunr.stemmer.support.min.js defer></script><script src=../js/lunr/lunr.multi.min.js defer></script><script src=../js/lunr/lunr.fr.min.js defer></script><script src=../js/search.js defer></script></div><div id=R-homelinks class="default-animation homelinks"><ul><li><a class=padding href=../><i class="fas fa-home"></i> Home</a></li></ul><hr class=padding></div><div id=R-content-wrapper class=highlightable><div id=R-topics><ul class="enlarge morespace collapsible-menu"><li data-nav-id=/cours1_presentation_kubernetes/><a class=padding href=../cours1_presentation_kubernetes/><b>1. </b>Presentation de Kubernetes<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/cours2_installation_kubernetes/><a class=padding href=../cours2_installation_kubernetes/><b>2. </b>Installer Kubernetes<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/td1-installation/><a class=padding href=../td1-installation/><b>3. </b>TD - Installation et Configuration<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/cours3_objets_kubernetes_partie1/ class=active><a class=padding href=../cours3_objets_kubernetes_partie1/><b>4. </b>Les objets Kubernetes - Partie 1<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/td2-deployer-wordpress/><a class=padding href=../td2-deployer-wordpress/><b>5. </b>TD - Deployer Wordpress<i class="fas fa-check read-icon"></i></a></li></ul></div><div id=R-shortcuts><div class="nav-title padding">Aller plus loin</div><ul class=space><li><a class=padding href=https://kubernetes.io/fr/docs/home/><i class="fab fa-book"></i> Documentation Kubernetes</a></li><li><a class=padding href=https://github.com/zaggash/tp-iut-kubernetes><i class="fab fa-github"></i> D√©p√¥t du TP</a></li><li><a class=padding href=https://www.linkedin.com/in/alexandre-pinon/><i class="fab fa-linkedin"></i> Profil Linkedin</a></li></ul></div><div class="padding footermargin footerLangSwitch footerVariantSwitch footerVisitedLinks footerFooter showVisitedLinks showFooter"></div><div id=R-menu-footer><hr class="padding default-animation footerLangSwitch footerVariantSwitch footerVisitedLinks footerFooter showVisitedLinks showFooter"><div id=R-prefooter class="footerLangSwitch footerVariantSwitch footerVisitedLinks showVisitedLinks"><ul><li id=R-select-language-container class=footerLangSwitch><div class="padding menu-control"><i class="fas fa-language fa-fw"></i>
<span>&nbsp;</span><div class=control-style><label class=a11y-only for=R-select-language>Langue</label>
<select id=R-select-language onchange="location=baseUri+this.value"></select></div><div class=clear></div></div></li><li id=R-select-variant-container class=footerVariantSwitch><div class="padding menu-control"><i class="fas fa-paint-brush fa-fw"></i>
<span>&nbsp;</span><div class=control-style><label class=a11y-only for=R-select-variant>Th√®me</label>
<select id=R-select-variant onchange=window.variants&&variants.changeVariant(this.value)><option id=R-blue value=blue selected>Blue</option></select></div><div class=clear></div></div><script>window.variants&&variants.markSelectedVariant()</script></li><li class="footerVisitedLinks showVisitedLinks"><div class="padding menu-control"><i class="fas fa-history fa-fw"></i>
<span>&nbsp;</span><div class=control-style><button onclick=clearHistory()>Supprimer l'historique</button></div><div class=clear></div></div></li></ul></div><div id=R-footer class="footerFooter showFooter"><center><p>Cr√©√© pour l'IUT Reims-Chalons-Charleville - Alexandre P.</p></center></div></div></div></aside><script src=../js/clipboard.min.js defer></script><script src=../js/perfect-scrollbar.min.js defer></script><script>function useMathJax(e){if(!Object.assign)return;window.MathJax=Object.assign(window.MathJax||{},{loader:{load:["[tex]/mhchem"]},startup:{elements:[".math"]},tex:{inlineMath:[["$","$"],["\\(","\\)"]]},options:{enableMenu:!1}},e)}useMathJax(JSON.parse("{}"))</script><script id=MathJax-script async src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><script src=../js/d3/d3-color.min.js defer></script><script src=../js/d3/d3-dispatch.min.js defer></script><script src=../js/d3/d3-drag.min.js defer></script><script src=../js/d3/d3-ease.min.js defer></script><script src=../js/d3/d3-interpolate.min.js defer></script><script src=../js/d3/d3-selection.min.js defer></script><script src=../js/d3/d3-timer.min.js defer></script><script src=../js/d3/d3-transition.min.js defer></script><script src=../js/d3/d3-zoom.min.js defer></script><script src=../js/js-yaml.min.js defer></script><script src=https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js defer></script><script>window.themeUseMermaid=JSON.parse('{ "theme": "default" }')</script><script src=../js/theme.js defer></script></body></html>